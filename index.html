<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protories | IA Vision</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0b0e14; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .garmin-blue { color: #00a9e0; }
        .progress-ring { transition: stroke-dashoffset 0.5s ease-in-out; transform: rotate(-90deg); transform-origin: 50% 50%; }
    </style>
</head>
<body class="p-6 max-w-md mx-auto">

    <div class="flex justify-between items-center mb-10">
        <div>
            <h1 class="text-2xl font-black italic tracking-tighter">PROTORIES <span class="garmin-blue text-sm not-italic font-bold">PRO</span></h1>
            <p id="date-now" class="text-[10px] text-slate-500 uppercase font-bold tracking-widest"></p>
        </div>
        <div id="status-dot" class="h-3 w-3 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]"></div>
    </div>

    <div class="relative flex justify-center items-center mb-10">
        <svg class="w-64 h-64">
            <circle cx="128" cy="128" r="110" stroke="#1e293b" stroke-width="12" fill="transparent" />
            <circle id="progress" cx="128" cy="128" r="110" stroke="#00a9e0" stroke-width="12" fill="transparent" 
                    stroke-dasharray="691" stroke-dashoffset="691" stroke-linecap="round" class="progress-ring" />
        </svg>
        <div class="absolute text-center">
            <span id="display-val" class="text-6xl font-black italic">0</span>
            <span class="block text-[10px] text-slate-500 font-bold uppercase mt-1">G PROTEINES / 160</span>
        </div>
    </div>

    <div class="mb-8">
        <label for="file-upload" id="ia-label" class="w-full bg-white text-black font-black py-5 rounded-2xl flex items-center justify-center gap-3 active:scale-95 transition-all cursor-pointer text-center">
            <span id="btn-text">üì∏ ANALYSER MON PLAT (IA)</span>
        </label>
        <input id="file-upload" type="file" accept="image/*" capture="environment" class="hidden" onchange="handleImage(this)">
        <p id="log" class="text-[10px] text-center mt-3 text-slate-600 italic uppercase tracking-wider">Pr√™t pour scan visuel</p>
    </div>

    <div class="grid grid-cols-2 gap-4">
        <button onclick="add(25)" class="bg-[#1e293b] p-4 rounded-xl border border-slate-800 text-left active:scale-95 transition-all">
            <span class="block text-[10px] text-slate-500 uppercase font-bold">Shaker</span>
            <span class="text-lg font-bold">+25g</span>
        </button>
        <button onclick="reset()" class="bg-[#1e293b] p-4 rounded-xl border border-red-900/20 text-left active:scale-95 transition-all">
            <span class="block text-[10px] text-red-500 uppercase font-bold">Reset</span>
            <span class="text-lg font-bold text-red-500 tracking-tighter">VIDER</span>
        </button>
    </div>

    <script>
        const API_KEY = "AIzaSyAoc-U6jQy6eiysfAQvel3m93tJfywNpxo";
        let total = parseInt(localStorage.getItem('prot_total')) || 0;
        const goal = 160;

        function update() {
            document.getElementById('display-val').innerText = total;
            const offset = 691 - (total / goal * 691);
            document.getElementById('progress').style.strokeDashoffset = Math.max(0, offset);
            localStorage.setItem('prot_total', total);
            document.getElementById('date-now').innerText = new Date().toLocaleDateString('fr-FR', {weekday:'long', day:'numeric', month:'short'});
        }

        function add(n) { total += n; update(); }
        function reset() { if(confirm('R√©initialiser ?')){ total = 0; update(); } }

        async function handleImage(input) {
            const file = input.files[0];
            if(!file) return;

            const label = document.getElementById('ia-label');
            const log = document.getElementById('log');
            const btnText = document.getElementById('btn-text');

            label.style.opacity = "0.5";
            btnText.innerText = "ANALYSE EN COURS...";
            log.innerText = "Envoi √† Gemini...";

            const reader = new FileReader();
            reader.onload = async () => {
                const base64 = reader.result.split(',')[1];
                try {
                    const resp = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [
                                { text: "Analyse cette photo de nourriture. Estime le poids total et donne UNIQUEMENT le nombre de grammes de prot√©ines total sous la forme d'un chiffre seul. Si tu ne vois pas de nourriture, r√©ponds 0." },
                                { inline_data: { mime_type: "image/jpeg", data: base64 } }
                            ]}]
                        })
                    });
                    
                    const data = await resp.json();
                    
                    if (data.error) {
                        log.innerText = "Erreur : " + data.error.message;
                        return;
                    }

                    const textResponse = data.candidates[0].content.parts[0].text;
                    const result = parseInt(textResponse.match(/\d+/)[0]);
                    
                    if(!isNaN(result)) {
                        total += result;
                        update();
                        log.innerText = `+${result}g prot√©ines d√©tect√©s !`;
                    } else {
                        log.innerText = "Impossible de lire le r√©sultat.";
                    }
                } catch (e) {
                    log.innerText = "Erreur r√©seau.";
                } finally {
                    label.style.opacity = "1";
                    btnText.innerText = "üì∏ ANALYSER MON PLAT (IA)";
                    input.value = '';
                }
            };
            reader.readAsDataURL(file);
        }
        update();
    </script>
</body>
</html>
